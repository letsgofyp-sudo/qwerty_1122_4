{% extends 'administration/base.html' %}
{% load static %}

{% block title %}Trip Detail {{ trip.trip_id }}{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    #tripMap { height:420px; border-radius:8px; overflow:hidden; margin-top:12px; }
    .badge-danger {
      background-color: #e74c3c;
    }

    /* Route stop markers on trip map (driver path only) */
    .route-stop-marker {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid #ffffff;
      box-shadow: 0 0 4px rgba(0,0,0,0.35);
    }
    .route-stop-start { background-color: #2ecc71; }   /* green */
    .route-stop-end { background-color: #e74c3c; }     /* red */
    .route-stop-mid { background-color: #e67e22; }     /* orange */

    .avatar-marker {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: 2px solid #ffffff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.35);
      overflow: hidden;
      background: #ffffff;
    }

    .avatar-marker img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .avatar-fallback {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      background: #f0f3f6;
      color: #2c3e50;
      border: 2px solid #ffffff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.35);
    }

    .driver-ring {
      outline: 3px solid rgba(46, 204, 113, 0.9);
      outline-offset: 1px;
    }

    .passenger-ring {
      outline: 3px solid rgba(52, 152, 219, 0.9);
      outline-offset: 1px;
    }

    .driver-icon {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: 2px solid #ffffff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.35);
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .driver-icon svg {
      width: 22px;
      height: 22px;
      fill: #2ecc71;
    }

    .pickup-fallback {
      opacity: 0.85;
    }

    .sos-marker {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: #e74c3c;
      border: 3px solid #ffffff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.35);
      position: relative;
    }
    .sos-marker:after {
      content: 'SOS';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 10px;
      font-weight: 800;
      color: #ffffff;
      letter-spacing: 0.5px;
    }
  </style>
{% endblock %}

{% block content %}
  <main class="user-main">
    <h1 class="page-title">Trip {{ trip.trip_id }} Detail</h1>

    <div class="user-detail-card">
      <div class="user-fields">
        <div class="user-text-field"><strong>Trip ID:</strong><br>{{ trip.trip_id }}</div>
        <div class="user-text-field"><strong>Date:</strong><br>{{ trip.trip_date|date:'Y-m-d' }}</div>
        <div class="user-text-field"><strong>Departure:</strong><br>{{ trip.departure_time|time:'H:i' }}</div>
        <div class="user-text-field"><strong>Estimated Arrival:</strong><br>{{ trip.estimated_arrival_time|time:'H:i' }}</div>
        <div class="user-text-field"><strong>Status:</strong><br>{{ trip.trip_status }}</div>
        <div class="user-text-field"><strong>Route:</strong><br>{{ trip.route.route_name }}</div>
        <div class="user-text-field"><strong>Driver:</strong><br>
          <a href="{% url 'administration:user_detail' user_id=trip.driver.id %}">{{ trip.driver.name }}</a>
        </div>
        <div class="user-text-field"><strong>Vehicle:</strong><br>
          {% if trip.vehicle %}
            <a href="{% url 'administration:vehicle_detail' user_id=trip.driver.id %}">{{ trip.vehicle.plate_number }}</a>
          {% else %}-{% endif %}
        </div>
        <div class="user-text-field"><strong>Total Seats:</strong><br>{{ trip.total_seats }}</div>
        <div class="user-text-field"><strong>Available Seats:</strong><br>{{ trip.available_seats }}</div>
        <div class="user-text-field"><strong>Occupied Seats:</strong><br>{{ trip.occupied_seats }}</div>
        <div class="user-text-field"><strong>Base Fare:</strong><br>{{ trip.base_fare }}</div>
        <div class="user-text-field"><strong>Total Distance (km):</strong><br>{{ trip.total_distance_km|default:'-' }}</div>
        <div class="user-text-field"><strong>Total Duration (min):</strong><br>{{ trip.total_duration_minutes|default:'-' }}</div>
        <div class="user-text-field"><strong>Negotiable:</strong><br>{{ trip.is_negotiable }}</div>
        <div class="user-text-field"><strong>Min. Acceptable Fare:</strong><br>{{ trip.minimum_acceptable_fare|default:'-' }}</div>
        <div class="user-text-field"><strong>Gender Preference:</strong><br>{{ trip.gender_preference }}</div>
        <div class="user-text-field"><strong>Created At:</strong><br>{{ trip.created_at|date:'Y-m-d H:i' }}</div>
        <div class="user-text-field"><strong>Updated At:</strong><br>{{ trip.updated_at|date:'Y-m-d H:i' }}</div>
      </div>

      <hr style="margin:2em 0;">

      <h2>Route Map</h2>
      <div id="tripMap"></div>
      <div class="map-summary" style="margin-top:10px;">
        <div class="map-summary-box" style="display:inline-block;">
          <div id="liveRuntime"></div>
        </div>
      </div>

      <h2 style="margin-top:2em;">Route Segments</h2>
      {% if segments %}
        <div class="vehicle-list" style="margin-top:12px;">
          {% for s in segments %}
            <div class="vehicle-card">
              <div class="vehicle-main-row">
                <div class="vehicle-main-item"><strong>From:</strong> {{ s.from_stop_name }} ({{ s.from_stop_order }})</div>
                <div class="vehicle-main-item"><strong>To:</strong> {{ s.to_stop_name }} ({{ s.to_stop_order }})</div>
                <div class="vehicle-main-item"><strong>Distance:</strong> {{ s.distance_km }} km</div>
                <div class="vehicle-main-item"><strong>Duration:</strong> {{ s.duration_minutes }} min</div>
                <div class="vehicle-main-item"><strong>Price:</strong> {{ s.price }}</div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p>No stop breakdown segments recorded for this trip.</p>
      {% endif %}

      <hr style="margin:2em 0;">

      <h2>Bookings</h2>
      {% if bookings %}
        <div class="tab-bar">
          {% for t in booking_tabs %}
            <button type="button"
                    class="tab-button booking-tab{% if forloop.first %} active{% endif %}"
                    data-booking="{{ t.id }}"
                    data-passenger="{{ t.passenger_id }}"
                    data-bookings="{{ t.booking_ids|join:',' }}">
              {{ t.passenger_name }} · {{ t.seats_display }} seat{% if t.seats > 1 %}s{% endif %} · {{ t.from_name }} → {{ t.to_name }}
            </button>
          {% endfor %}
        </div>
        <div class="booking-list" style="margin-top:12px;">
          {% for b in bookings %}
            <div class="booking-card booking-row"
                 data-passenger-id="{{ b.passenger.id }}"
                 data-booking-id="{{ b.id }}"
                 {% if not forloop.first %}style="display:none;"{% endif %}>
              <div class="booking-header">
                <div><strong>Booking ID:</strong> {{ b.booking_id }}</div>
                <div><strong>Passenger:</strong> {{ b.passenger.name }}</div>
                <div><strong>From  To:</strong> {{ b.from_stop.stop_name }}  {{ b.to_stop.stop_name }}</div>
                <div><strong>Seats:</strong>
                  {% if b.male_seats|add:b.female_seats > 0 %}
                    {{ b.male_seats|add:b.female_seats }} (M:{{ b.male_seats }} F:{{ b.female_seats }})
                  {% else %}
                    {{ b.number_of_seats }}
                  {% endif %}
                </div>
              </div>
              <div class="booking-body">
                <div><strong>Total Fare:</strong> {{ b.total_fare }}</div>
                <div><strong>Booking Status:</strong> {{ b.booking_status }}</div>
                <div><strong>Payment Status:</strong> {{ b.payment_status }}</div>
                <div><strong>Payment Method:</strong> {{ b.latest_payment_method|default:'-' }}</div>
                <div><strong>Ride Status:</strong> {{ b.ride_status|default:'-' }}</div>
                <div><strong>Pickup Verified At:</strong> {{ b.pickup_verified_at|date:'Y-m-d H:i'|default:'-' }}</div>
                <div><strong>Dropped Off At:</strong> {{ b.dropoff_at|date:'Y-m-d H:i'|default:'-' }}</div>
                <div><strong>Bargaining Status:</strong> {{ b.bargaining_status }}</div>
                <div><strong>Passenger Offer:</strong> {{ b.passenger_offer|default:'-' }}</div>
                <div><strong>Driver Response:</strong> {{ b.driver_response|default:'-' }}</div>
                <div><strong>Negotiated Fare:</strong> {{ b.negotiated_fare|default:'-' }}</div>
                <div><strong>Booked At:</strong> {{ b.booked_at|date:'Y-m-d H:i' }}</div>
                <div><strong>Receipt:</strong>
                  {% if b.latest_payment_method == 'CASH' %}
                    Cash
                  {% elif b.latest_receipt_url %}
                    <a href="{{ b.latest_receipt_url }}" target="_blank">View</a>
                  {% else %}
                    -
                  {% endif %}
                </div>
                <div><strong>Passenger → Driver Rating:</strong> {{ b.driver_rating|default:'-' }}</div>
                <div><strong>Passenger → Driver Comment:</strong> {{ b.driver_feedback|default:'-' }}</div>
                <div><strong>Driver → Passenger Rating:</strong> {{ b.passenger_rating|default:'-' }}</div>
                <div><strong>Driver → Passenger Comment:</strong> {{ b.passenger_feedback|default:'-' }}</div>
              </div>
              <div class="booking-actions">
                <a href="{% url 'administration:admin_booking_map' booking_pk=b.id %}">
                  <button type="button">View on Map</button>
                </a>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p>No bookings for this trip yet.</p>
      {% endif %}

      <hr style="margin:2em 0;">

      <h2>Payments Summary</h2>
      <div class="user-fields">
        <div class="user-text-field"><strong>Total Payments (all statuses):</strong><br>{{ payments_total }}</div>
        <div class="user-text-field"><strong>Completed Payments:</strong><br>{{ payments_completed }}</div>
      </div>

      <hr style="margin:2em 0;">

      <h2>Chat</h2>
      {% if chat_group %}
        <div class="user-fields">
          <div class="user-text-field"><strong>Chat Group:</strong><br>{{ chat_group.group_name }}</div>
          <div class="user-text-field"><strong>Members:</strong><br>{{ chat_group.member_count }}</div>
        </div>

        <h3 style="margin-top:1.5em;">Members</h3>
        {% if members %}
          <ul style="margin-top:0.5em; margin-left:1.2em;">
            {% for m in members %}
              <li>{{ m.user.name }} ({{ m.member_type }})</li>
            {% endfor %}
          </ul>
        {% else %}
          <p>No active members in this chat group.</p>
        {% endif %}

        <h3 style="margin-top:1.5em;">Messages</h3>
        {% if booking_tabs %}
          <div class="tab-bar" style="margin-top:4px;">
            {% for t in booking_tabs %}
              <button type="button"
                      class="tab-button booking-tab{% if forloop.first %} active{% endif %}"
                      data-booking="{{ t.id }}"
                      data-passenger="{{ t.passenger_id }}"
                      data-bookings="{{ t.booking_ids|join:',' }}">
                {{ t.passenger_name }} · {{ t.seats }} seat{% if t.seats > 1 %}s{% endif %} · {{ t.from_name }} → {{ t.to_name }}
              </button>
            {% endfor %}
          </div>
        {% endif %}
        {% if messages %}
          <div class="chat-container">
            {% for msg in messages %}
              <div
                class="chat-message msg-row
                       {% if msg.message_type == 'SYSTEM' %}system{% elif msg.sender.id == trip.driver.id %}from-driver{% else %}from-passenger{% endif %}"
                data-sender-id="{{ msg.sender.id }}"
                {% if msg.message_type == 'SYSTEM' %}data-system="1"{% endif %}
              >
                <div class="chat-meta">
                  <span>{{ msg.created_at|date:'Y-m-d H:i' }}</span>
                  <span>|</span>
                  <span>{{ msg.sender.name }}</span>
                  <span>|</span>
                  <span>{{ msg.message_type }}</span>
                </div>
                <div class="chat-text">{{ msg.get_display_text }}</div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p>No messages in this chat group yet.</p>
        {% endif %}
      {% else %}
        <p>No chat group associated with this trip.</p>
      {% endif %}
    </div>
  </main>
{% endblock %}

{% block scripts %}
  {{ route_stops_full_data|json_script:"routeStopsFullData" }}
  {{ route_geometry_data|json_script:"routeGeometryData" }}
  {{ booking_markers_data|json_script:"bookingMarkersData" }}
  {{ segments_coords_data|json_script:"segmentsCoordsData" }}
  {{ trip_meta_data|json_script:"tripMetaData" }}
  {{ booking_meta_data|json_script:"bookingMetaData" }}
  {{ sos_markers_data|json_script:"sosMarkersData" }}

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    (function() {
      const mapEl = document.getElementById('tripMap');
      if (!mapEl) return;

      const map = L.map('tripMap');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const bounds = [];

      // Build full ordered route stops for marker display
      const routeStopsFull = JSON.parse(
        (document.getElementById('routeStopsFullData')?.textContent || '[]')
      );

      // Prefer dense geometry points from backend for main route polyline
      const routeGeometry = JSON.parse(
        (document.getElementById('routeGeometryData')?.textContent || '[]')
      );
      const geometryPoints = routeGeometry.map(p => [p.lat, p.lng]);

      if (geometryPoints.length >= 2) {
        const cleanPath = geometryPoints;
        L.polyline(cleanPath, { color: '#2980b9', weight: 4, opacity: 0.95 }).addTo(map);
        cleanPath.forEach(pt => bounds.push(pt));

        // Mark all logical route stops along the geometry with pin-style markers
        routeStopsFull.forEach((rs, idx) => {
          const isFirst = idx === 0;
          const isLast = idx === routeStopsFull.length - 1;
          const cls = isFirst ? 'route-stop-start' : (isLast ? 'route-stop-end' : 'route-stop-mid');
          const icon = L.divIcon({
            className: `route-stop-marker ${cls}`,
            iconSize: [16, 16],
            iconAnchor: [8, 8]
          });
          const marker = L.marker([rs.lat, rs.lng], { icon }).addTo(map);
          let label = rs.name || `Stop ${idx + 1}`;
          if (isFirst) {
            label = 'Route Start: ' + label;
          } else if (isLast) {
            label = 'Route End: ' + label;
          }
          marker.bindPopup(label);
          bounds.push([rs.lat, rs.lng]);
        });
      } else {
        // Next preference: full ordered route stops (if geometry not present)
        if (routeStopsFull.length >= 2) {
          const cleanPath = routeStopsFull.map(rs => [rs.lat, rs.lng]);
          L.polyline(cleanPath, { color: '#2980b9', weight: 4, opacity: 0.9 }).addTo(map);
          cleanPath.forEach(pt => bounds.push(pt));

          // Mark all route stops: start, intermediate, destination with color coding
          routeStopsFull.forEach((rs, idx) => {
            const isFirst = idx === 0;
            const isLast = idx === routeStopsFull.length - 1;
            const cls = isFirst ? 'route-stop-start' : (isLast ? 'route-stop-end' : 'route-stop-mid');
            const icon = L.divIcon({
              className: `route-stop-marker ${cls}`,
              iconSize: [16, 16],
              iconAnchor: [8, 8]
            });
            const marker = L.marker([rs.lat, rs.lng], { icon }).addTo(map);
            let label = rs.name || `Stop ${idx + 1}`;
            if (isFirst) {
              label = 'Route Start: ' + label;
            } else if (isLast) {
              label = 'Route End: ' + label;
            }
            marker.bindPopup(label);
          });
        } else {
          // Fallback: use TripStopBreakdown segments if route stops are missing
          const segmentCoords = JSON.parse(
            (document.getElementById('segmentsCoordsData')?.textContent || '[]')
          );

          segmentCoords.forEach(seg => {
            const line = L.polyline(seg, { color: '#2980b9', weight: 4, opacity: 0.8 }).addTo(map);
            seg.forEach(pt => bounds.push(pt));
          });
        }
      }

      // Bookings pickup/drop-off markers using RouteStop coordinates
      const bookingMarkers = JSON.parse(
        (document.getElementById('bookingMarkersData')?.textContent || '[]')
      );

      bookingMarkers.forEach(m => {
        const color = m.type === 'pickup' ? 'green' : 'red';
        const marker = L.circleMarker([m.lat, m.lng], {
          radius: 6,
          color,
          fillColor: color,
          fillOpacity: 0.9
        }).addTo(map);
        marker.bindPopup(m.label);
        bounds.push([m.lat, m.lng]);
      });

      function _sosIcon() {
        return L.divIcon({
          className: '',
          html: '<div class="sos-marker"></div>',
          iconSize: [26, 26],
          iconAnchor: [13, 13],
        });
      }

      // SOS incidents markers
      const sosMarkers = JSON.parse(
        (document.getElementById('sosMarkersData')?.textContent || '[]')
      );
      sosMarkers.forEach(i => {
        if (!i || i.lat == null || i.lng == null) return;
        const marker = L.marker([Number(i.lat), Number(i.lng)], { icon: _sosIcon() }).addTo(map);
        const note = i.note ? String(i.note) : '-';
        const who = i.actor_name ? String(i.actor_name) : 'User';
        const role = i.role ? String(i.role) : '-';
        marker.bindPopup(`<strong>SOS</strong><br/>${who} (${role})<br/>${note}`);
        bounds.push([Number(i.lat), Number(i.lng)]);
      });

      if (bounds.length) {
        map.fitBounds(bounds, { padding: [20, 20] });
      } else {
        // Fallback center if no coords
        map.setView([30.3753, 69.3451], 5); // Pakistan approx
      }

      const tripMeta = JSON.parse(
        (document.getElementById('tripMetaData')?.textContent || '{}')
      );
      const bookingMetaList = JSON.parse(
        (document.getElementById('bookingMetaData')?.textContent || '[]')
      );
      const bookingMetaById = new Map(bookingMetaList.map(b => [String(b.booking_id), b]));

      function _initials(name) {
        if (!name) return 'U';
        const parts = String(name).trim().split(/\s+/).filter(Boolean);
        const a = parts[0]?.[0] || 'U';
        const b = parts.length > 1 ? (parts[parts.length - 1]?.[0] || '') : '';
        return (a + b).toUpperCase();
      }

      function _avatarIcon(photoUrl, name, ringClass) {
        if (photoUrl) {
          const html = `<div class="avatar-marker ${ringClass}"><img src="${photoUrl}" alt="" /></div>`;
          return L.divIcon({
            className: '',
            html,
            iconSize: [38, 38],
            iconAnchor: [19, 19],
          });
        }
        const html = `<div class="avatar-fallback ${ringClass}">${_initials(name)}</div>`;
        return L.divIcon({
          className: '',
          html,
          iconSize: [38, 38],
          iconAnchor: [19, 19],
        });
      }

      function _driverIcon() {
        const svg = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20 8h-1.81l-1.62-3.24A2 2 0 0 0 14.79 3H9.21a2 2 0 0 0-1.78 1.76L5.81 8H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h1a3 3 0 0 0 6 0h2a3 3 0 0 0 6 0h1a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2Zm-2.76 0H6.76l1.2-2.4c.16-.32.49-.6.85-.6h6.38c.36 0 .69.28.85.6L17.24 8ZM8 19a1 1 0 1 1 0-2 1 1 0 0 1 0 2Zm8 0a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>';
        const html = `<div class="driver-icon driver-ring">${svg}</div>`;
        return L.divIcon({
          className: '',
          html,
          iconSize: [38, 38],
          iconAnchor: [19, 19],
        });
      }

      const liveLayer = L.layerGroup().addTo(map);
      let driverMarker = null;
      const passengerMarkers = new Map();
      const passengerPickupFallbackMarkers = new Map();
      let driverPathLine = null;

      function _bookingPopupHtml(meta) {
        if (!meta) return '';
        const start = meta.from_stop_name || '-';
        const end = meta.to_stop_name || '-';
        const p2d = meta.passenger_to_driver_rating != null ? meta.passenger_to_driver_rating : '-';
        const d2p = meta.driver_to_passenger_rating != null ? meta.driver_to_passenger_rating : '-';
        return `
          <div style="min-width:220px">
            <div><strong>${meta.passenger_name || 'Passenger'}</strong></div>
            <div style="margin-top:6px"><strong>Route:</strong> ${start} → ${end}</div>
            <div style="margin-top:6px"><strong>Passenger → Driver:</strong> ${p2d}</div>
            <div><strong>Driver → Passenger:</strong> ${d2p}</div>
          </div>
        `;
      }

      async function fetchLiveState() {
        if (!tripMeta.trip_id) return null;
        const tripIdEncoded = encodeURIComponent(tripMeta.trip_id);
        const url = `/lets_go/trips/${tripIdEncoded}/location/`;
        try {
          const res = await fetch(url, { method: 'GET', credentials: 'same-origin' });
          const data = await res.json();
          return data && data.success ? data : null;
        } catch (e) {
          return null;
        }
      }

      function renderLiveState(payload) {
        if (!payload || !payload.live_state) return;
        const live = payload.live_state;

        const pathRaw = Array.isArray(live.driver_path) ? live.driver_path : [];
        const path = pathRaw
          .filter(p => p && p.lat != null && p.lng != null)
          .map(p => [Number(p.lat), Number(p.lng)]);

        const driverMeta = payload.driver_meta || {};
        const lastSeen = driverMeta.last_seen_seconds;
        const signalLost = driverMeta.signal_lost === true || (typeof lastSeen === 'number' && lastSeen > 30);
        const pathColor = signalLost ? '#e74c3c' : '#8e44ad';

        if (path.length >= 2) {
          if (!driverPathLine) {
            driverPathLine = L.polyline(path, { color: pathColor, weight: 4, opacity: 0.9 }).addTo(liveLayer);
          } else {
            driverPathLine.setLatLngs(path);
            driverPathLine.setStyle({ color: pathColor });
          }
        } else {
          if (driverPathLine) {
            liveLayer.removeLayer(driverPathLine);
            driverPathLine = null;
          }
        }

        try {
          const rtEl = document.getElementById('liveRuntime');
          if (rtEl) {
            const rt = payload.runtime || {};
            const pieces = [];
            if (signalLost) {
              pieces.push(`<div><strong>Signal:</strong> Lost${typeof lastSeen === 'number' ? ` (${Number(lastSeen)}s ago)` : ''}</div>`);
            } else if (typeof lastSeen === 'number') {
              pieces.push(`<div><strong>Last seen:</strong> ${Number(lastSeen)}s ago</div>`);
            }
            if (rt.driver_speed_kph != null) {
              pieces.push(`<div><strong>Speed:</strong> ${Number(rt.driver_speed_kph).toFixed(1)} km/h</div>`);
            }
            if (rt.driver_eta_seconds_to_final != null) {
              const mins = Math.max(Math.round(Number(rt.driver_eta_seconds_to_final) / 60), 0);
              pieces.push(`<div><strong>ETA (to final):</strong> ${mins} min</div>`);
            }
            rtEl.innerHTML = pieces.join('');
          }
        } catch (e) {}

        const drv = live.driver;
        if (drv && drv.lat != null && drv.lng != null) {
          const icon = _driverIcon();
          const pos = [Number(drv.lat), Number(drv.lng)];
          if (!driverMarker) {
            driverMarker = L.marker(pos, { icon }).addTo(liveLayer);
          } else {
            driverMarker.setLatLng(pos);
            driverMarker.setIcon(icon);
          }
          driverMarker.bindPopup(`<strong>Driver:</strong> ${tripMeta.driver_name || 'Driver'}`);
        }

        const passengers = Array.isArray(live.passengers) ? live.passengers : [];
        const seen = new Set();
        passengers.forEach(p => {
          if (!p || p.lat == null || p.lng == null) return;
          const bid = p.booking_id != null ? String(p.booking_id) : null;
          if (!bid) return;
          seen.add(bid);

          const meta = bookingMetaById.get(bid);
          const name = (meta && meta.passenger_name) ? meta.passenger_name : (p.name || 'Passenger');
          const photo = (meta && meta.passenger_profile_photo) ? meta.passenger_profile_photo : (p.profile_photo || null);
          const icon = _avatarIcon(photo, name, 'passenger-ring');
          const pos = [Number(p.lat), Number(p.lng)];

          let m = passengerMarkers.get(bid);
          if (!m) {
            m = L.marker(pos, { icon }).addTo(liveLayer);
            passengerMarkers.set(bid, m);
          } else {
            m.setLatLng(pos);
            m.setIcon(icon);
          }
          m.bindPopup(_bookingPopupHtml(meta) || `<strong>${name}</strong>`);
        });

        // Fallback markers at passenger pickup locations when passenger live state is not available
        bookingMetaList.forEach(meta => {
          const bid = meta && meta.booking_id != null ? String(meta.booking_id) : null;
          if (!bid) return;
          if (seen.has(bid)) {
            const fm = passengerPickupFallbackMarkers.get(bid);
            if (fm) {
              liveLayer.removeLayer(fm);
            }
            passengerPickupFallbackMarkers.delete(bid);
            return;
          }

          const lat = meta.from_stop_lat;
          const lng = meta.from_stop_lng;
          if (lat == null || lng == null) return;

          const name = meta.passenger_name || 'Passenger';
          const photo = meta.passenger_profile_photo || null;
          const icon = _avatarIcon(photo, name, 'passenger-ring');
          const pos = [Number(lat), Number(lng)];

          let fm = passengerPickupFallbackMarkers.get(bid);
          if (!fm) {
            fm = L.marker(pos, { icon, opacity: 0.9 }).addTo(liveLayer);
            passengerPickupFallbackMarkers.set(bid, fm);
          } else {
            fm.setLatLng(pos);
            fm.setIcon(icon);
          }
          try {
            const el = fm.getElement();
            if (el) {
              el.classList.add('pickup-fallback');
            }
          } catch (e) {}
          fm.bindPopup(_bookingPopupHtml(meta) || `<strong>${name}</strong>`);
        });

        Array.from(passengerMarkers.keys()).forEach(bid => {
          if (!seen.has(bid)) {
            const m = passengerMarkers.get(bid);
            if (m) {
              liveLayer.removeLayer(m);
            }
            passengerMarkers.delete(bid);
          }
        });
      }

      let polling = false;
      async function poll() {
        if (polling) return;
        polling = true;
        const payload = await fetchLiveState();
        if (payload) {
          renderLiveState(payload);
        }
        polling = false;
      }

      poll();
      setInterval(poll, 3500);
    })();
  </script>
  <script>
    (function() {
      const tripMeta = JSON.parse(
        (document.getElementById('tripMetaData')?.textContent || '{}')
      );
      const driverId = tripMeta.driver_id;
      const tabButtons = document.querySelectorAll('.booking-tab');
      const bookingRows = document.querySelectorAll('.booking-row');
      const msgRows = document.querySelectorAll('.msg-row');

      function setActiveBookingGroup(bookingIds, passengerId) {
        const idSet = new Set(bookingIds.map(String));

        // Tabs
        tabButtons.forEach(btn => {
          const btnIds = (btn.getAttribute('data-bookings') || '').split(',').filter(Boolean);
          const btnHasAny = btnIds.some(id => idSet.has(id));
          if (btnHasAny) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });

        // Bookings: show all cards that belong to this group
        bookingRows.forEach(row => {
          const rowBookingId = row.getAttribute('data-booking-id');
          if (idSet.has(rowBookingId)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });

        // Messages: show those from passenger of selected booking, driver, or system
        msgRows.forEach(row => {
          const senderId = row.getAttribute('data-sender-id');
          const isSystem = row.getAttribute('data-system') === '1';
          if (isSystem || senderId === String(passengerId) || senderId === String(driverId)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      }

      tabButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          const idsStr = this.getAttribute('data-bookings') || '';
          const ids = idsStr.split(',').filter(Boolean);
          const pId = this.getAttribute('data-passenger');
          setActiveBookingGroup(ids, pId);
        });
      });

      // Initial state: first booking tab if exists
      try {
        const first = tabButtons && tabButtons.length ? tabButtons[0] : null;
        if (first) {
          const idsStr = first.getAttribute('data-bookings') || '';
          const ids = idsStr.split(',').filter(Boolean);
          const pId = first.getAttribute('data-passenger');
          setActiveBookingGroup(ids, pId);
        }
      } catch (e) {}
    })();
  </script>
{% endblock %}
