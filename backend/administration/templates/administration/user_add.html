{% extends 'administration/base.html' %}
{% load static %}

{% block title %}Add User{% endblock %}

{% block content %}
  <main class="user-main">
    <h1 class="page-title">Add New User</h1>
    {% if error %}
      <div class="error" style="color: red; margin-bottom: 1em;">{{ error }}</div>
    {% endif %}
    <div id="formError" style="color:red;margin-bottom:1em;"></div>
    <form id="userAddForm" method="post" action="" enctype="multipart/form-data" class="user-edit-form">
      {% csrf_token %}
      <div class="form-row"><label>Name:</label><input type="text" name="name" required></div>
      <div class="form-row"><label>Email:</label><input type="email" name="email" required></div>
      <div class="form-row"><label>Password:</label><input type="password" name="password" required></div>
      <div class="form-row"><label>Username:</label><input type="text" name="username" required></div>
      <div class="form-row"><label>Address:</label><input type="text" name="address"></div>
      <div class="form-row"><label>Phone No:</label><input type="text" name="phone_no"></div>
      <div class="form-row"><label>Gender:</label>
        <select name="gender">
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
      </div>
      <div class="form-row"><label>Status:</label>
        <select name="status">
          <option value="PENDING">PENDING</option>
          <option value="VERIFIED">VERIFIED</option>
          <option value="REJECTED">REJECTED</option>
          <option value="BANNED">BANNED</option>
        </select>
      </div>
      <div class="form-row"><label>Driver Rating:</label><input type="number" step="0.01" name="driver_rating"></div>
      <div class="form-row"><label>Passenger Rating:</label><input type="number" step="0.01" name="passenger_rating"></div>
      <div class="form-row"><label>CNIC No:</label><input type="text" name="cnic_no"></div>
      <div class="form-row"><label>CNIC Front Image:</label><input type="file" name="cnic_front_image" accept="image/*"></div>
      <div class="form-row"><label>CNIC Back Image:</label><input type="file" name="cnic_back_image" accept="image/*"></div>
      <div class="form-row"><label>Driving License No:</label><input type="text" name="driving_license_no"></div>
      <div class="form-row"><label>Driving License Front:</label><input type="file" name="driving_license_front" accept="image/*"></div>
      <div class="form-row"><label>Driving License Back:</label><input type="file" name="driving_license_back" accept="image/*"></div>
      <div class="form-row"><label>Account No:</label><input type="text" name="accountno"></div>
      <div class="form-row"><label>IBAN:</label><input type="text" name="iban"></div>
      <div class="form-row"><label>Bank Name:</label><input type="text" name="bankname"></div>
      <div class="form-row"><label>Account QR:</label><input type="file" name="accountqr" accept="image/*"></div>
      <div class="form-row"><label>Profile Photo:</label><input type="file" name="profile_photo" accept="image/*"></div>
      <div class="form-row"><label>Live Photo:</label><input type="file" name="live_photo" accept="image/*"></div>

      <div class="form-row"><label>Emergency Contact Name:</label><input type="text" name="emergency_name"></div>
      <div class="form-row"><label>Emergency Relation:</label><input type="text" name="emergency_relation"></div>
      <div class="form-row"><label>Emergency Email:</label><input type="email" name="emergency_email"></div>
      <div class="form-row"><label>Emergency Phone (10-15 digits):</label><input type="text" name="emergency_phone_no"></div>

      <div class="form-row"><button type="submit">Add User</button></div>
    </form>
  </main>
{% endblock %}

{% block scripts %}
  <script>
    document.getElementById('userAddForm').addEventListener('submit', function(e) {
      let errors = [];
      const form = e.target;
      const name = form.name.value.trim();
      const username = form.username.value.trim();
      const email = form.email.value.trim();
      const password = form.password.value;
      const phone = form.phone_no.value.trim();
      const cnic = form.cnic_no.value.trim();
      const accountno = form.accountno.value.trim();
      const iban = form.iban.value.trim();
      const bankname = form.bankname.value.trim();
      const licenseNo = form.driving_license_no.value.trim();
      const licenseFront = form.driving_license_front.files[0];
      const licenseBack = form.driving_license_back.files[0];
      // Required fields
      if (!name) errors.push('Name is required.');
      if (!username) errors.push('Username is required.');
      if (!email) errors.push('Email is required.');
      if (!password) errors.push('Password is required.');
      // Email format
      if (email && !/^\S+@\S+\.\S+$/.test(email)) errors.push('Invalid email format.');
      // Password complexity
      if (password && !/(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,}/.test(password)) {
        errors.push('Password must be at least 8 characters and contain uppercase, lowercase, digit, and special character.');
      }
      // Phone number format
      if (phone && !/^\+\d{10,15}$/.test(phone)) errors.push('Phone number must be in international format, e.g. +923001234567.');
      // CNIC format
      if (cnic && !/^\d{5}-\d{7}-\d{1}$/.test(cnic)) errors.push('CNIC must be in the format 36603-0269853-9.');
      // License images required if license no
      if (licenseNo && (!licenseFront || !licenseBack)) {
        errors.push('Both front and back images of the driving license are required if license number is provided.');
      }
      if (errors.length) {
        document.getElementById('formError').innerText = errors.join('\n');
        e.preventDefault();
      }
    });
  </script>
{% endblock %}
